# Pixel Hero ARPG - 项目说明文档

## 1. 项目概述

### 1.1 游戏简介
Pixel Hero ARPG 是一款基于 HTML5 Canvas 的实时动作角色扮演游戏（ARPG）。玩家在像素风格的游戏世界中冒险，击败怪物、获取装备、提升等级，挑战强大的 Boss。

### 1.2 技术栈
- **前端**: 纯 HTML5 + CSS3 + JavaScript（ES6）
- **渲染**: HTML5 Canvas 2D Context
- **无需依赖**: 不使用任何第三方库，纯原生实现

### 1.3 核心特性
- 实时战斗系统（ARPG）
- 装备系统（武器、服装、帽子、靴子、戒指、项链）
- 技能系统（6种投射技能）
- 物品掉落与自动拾取
- Boss 战斗
- 等级成长系统
- **装备品质系统**（白/绿/蓝/紫/金）
- **商店系统**（购买/出售/刷新）
- **无限背包**（无容量限制）
- **角色面板**（装备外观显示）
- **地图系统**（墙壁、草地、水域、地面）
- **呼吸动画**（玩家、敌人）
- **IndexedDB存档**

---

## 2. 文件结构

```
PixelARPG/
├── index.html          # 游戏入口文件
├── css/
│   └── style.css      # 所有样式（UI、装备品质颜色）
├── js/
│   ├── data.js        # 物品、技能、敌人类型、装备品质、地图生成
│   ├── renderer.js    # 渲染函数（精灵、地图、粒子、掉落物、投射物）
│   └── game.js        # 主游戏逻辑、UI交互、背包、商店、角色面板、存档
└── README.md          # 项目说明文档
```

游戏已模块化，分为数据层、渲染层和游戏逻辑层。

---

## 3. 代码架构

### 3.1 整体结构

```
┌─────────────────────────────────────────────┐
│              HTML 结构                       │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────────────┐ │
│  │stats│ │equip│ │skills│ │  inventory  │ │
│  └─────┘ └─────┘ └─────┘ └─────────────┘ │
│              │canvas│                       │
│              └─────┘                       │
│  ┌─────────────────────────────────────┐    │
│  │         controls (dpad)            │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│           JavaScript 逻辑                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │  游戏数据 │ │  游戏循环 │ │  渲染系统 │  │
│  │  Game Data│ │Game Loop │ │ Rendering│  │
│  └──────────┘ └──────────┘ └──────────┘  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │  实体系统 │ │  战斗系统 │ │ UI系统   │  │
│  │ Entities │ │  Combat  │ │    UI    │  │
│  └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────┘
```

### 3.2 核心模块说明

#### 3.2.1 游戏数据（Game Data）

**物品定义** (`items` 数组)
```javascript
const items = [
    { id, name, type, atk, def, hp, mp, icon, sprite }
]
```
- `id`: 物品唯一标识
- `type`: 物品类型（weapon/clothes/hat/boots/ring/necklace/consumable/treasure）
- `atk/def/hp/mp`: 属性加成
- `icon`: 显示图标（Emoji）
- `sprite`: 像素精灵样式
- `quality`: 品质等级（common/uncommon/rare/epic/legendary）

**技能定义** (`skills` 数组)
```javascript
const skills = [
    { id, name, icon, mp, cd, damage, range, type, desc }
]
```
- `type`: 技能类型（single/projectile/aoe/self/spin）
- `mp`: 魔法消耗
- `cd`: 冷却时间（帧）
- `damage`: 伤害倍率
- `range`: 攻击范围

**玩家状态** (`player` 对象)
```javascript
const player = {
    x, y,              // 位置
    w, h,              // 尺寸
    hp, maxHp,         // 生命值
    mp, maxMp,         // 魔法值
    atk, def,          // 攻击/防御
    level, exp, gold,  // 等级/经验/金币
    weapon, armor, helmet, accessory,  // 装备
    inventory,          // 背包
    dirX, dirY,        // 面向方向
    attacking,         // 攻击动画状态
    invulnerable       // 无敌状态
}
```

#### 3.2.2 游戏循环（Game Loop）

```javascript
function gameLoop() {
    update();  // 更新游戏逻辑
    draw();    // 渲染画面
    requestAnimationFrame(gameLoop);
}
```

- **update()**: 每帧调用，处理所有游戏逻辑
- **draw()**: 每帧调用，渲染所有游戏对象

#### 3.2.3 实体系统

**敌人** (`enemies` 数组)
```javascript
{
    x, y, w, h,           // 位置和尺寸
    hp, maxHp, atk, def,  // 属性
    type, name,           // 类型和名称
    vx, vy,               // 速度
    attackCooldown         // 攻击冷却
}
```

**Boss** (单例对象)
```javascript
{
    // 同敌人属性
    x, y, w, h, hp, maxHp, atk, def,
    name, color,          // 名称和颜色
    phase, specialAttack  // 阶段和特殊攻击
}
```

**掉落物** (`drops` 数组)
```javascript
{
    x, y,                 // 位置
    item,                 // 物品对象
    life                  // 存在时间
}
```

**投射物** (`projectiles` 数组)
```javascript
{
    x, y,                 // 位置
    vx, vy,               // 速度
    damage, type, life    // 伤害、类型、存在时间
}
```

**粒子效果** (`particles` 数组)
```javascript
{
    x, y,                 // 位置
    vx, vy,               // 速度
    life, color           // 存在时间和颜色
}
```

#### 3.2.4 战斗系统

**攻击检测**
```javascript
function isInDirection(targetX, targetY) {
    // 检测目标是否在玩家面向的方向上
    // 考虑 dirX, dirY 和目标的相对位置
}
```

**伤害计算**
```javascript
const dmg = Math.max(1, player.atk - enemy.def + randomVariance);
```

#### 3.2.5 渲染系统

**像素精灵绘制** (`drawPixelSprite`)
- 玩家角色：支持不同装备外观（武器、防具、头盔）
- 敌人：根据类型绘制不同造型
- Boss：更大尺寸，不同颜色

**特效渲染**
- 攻击弧线（弧形轨迹）
- 粒子效果（血液、火花）
- 掉落物发光效果

#### 3.2.6 UI 系统

**HTML DOM 覆盖层**
- `#stats`: 角色状态（HP、MP、等级、ATK、DEF）
- `#equipment`: 装备显示
- `#skills`: 技能栏
- `#inventory`: 背包
- `#messages`: 消息提示

---

## 4. 核心机制详解

### 4.1 移动系统

```javascript
if (dx !== 0 || dy !== 0) {
    player.dirX = dx;
    player.dirY = dy;
}
// 基于方向键或触屏输入更新位置
```

**特性**:
- 8方向移动支持
- 碰撞检测（基于瓦片地图）
- 移动时更新面向方向

### 4.2 战斗系统

**普通攻击**
- 冷却时间：300ms
- 攻击范围：50像素
- 方向检测：只攻击面向方向的敌人
- 命中效果：击退 + 粒子特效

**技能系统**
| 技能 | 类型 | MP消耗 | 冷却 | 效果 |
|------|------|--------|------|------|
| Slash | 斩击 | 0 | 0s | 基础攻击 |
| Fireball | 投射 | 20 | 5s | 火球术 |
| Thunder | AOE | 30 | 8s | 雷电术 |
| Vine | 投射 | 25 | 7s | 藤蔓术 |
| Tornado | AOE | 35 | 10s | 旋风 |
| Ice | 投射 | 25 | 6s | 冰锥术 |

### 4.3 装备系统

**装备类型**
1. **武器 (weapon)**: 增加攻击力
2. **服装 (clothes)**: 增加防御力
3. **帽子 (hat)**: 增加防御力
4. **靴子 (boots)**: 增加防御力
5. **戒指 (ring)**: 攻/防/血量/魔法加成
6. **项链 (necklace)**: 攻/防/血量/魔法加成

**装备品质**
| 品质 | 颜色 | 等级需求加成 | 属性加成 |
|------|------|-------------|---------|
| 普通 (Common) | 白色 #ffffff | 无 | 100% |
| 优秀 (Uncommon) | 绿色 #00ff00 | +5 | 150% |
| 稀有 (Rare) | 蓝色 #0088ff | +10 | 200% |
| 史诗 (Epic) | 紫色 #aa00ff | +15 | 300% |
| 传说 (Legendary) | 金色 #ffaa00 | +20 | 500% |

**装备属性计算**
```javascript
player.atk = 10 + (weapon?.atk || 0) + (ring?.atk || 0) + (necklace?.atk || 0);
player.def = 5 + (clothes?.def || 0) + (hat?.def || 0) + (boots?.def || 0) + (ring?.def || 0) + (necklace?.def || 0);
player.maxHp = 100 + (ring?.maxHp || 0) + (necklace?.maxHp || 0);
player.maxMp = 150 + (ring?.maxMp || 0) + (necklace?.maxMp || 0);
```

### 4.4 物品掉落系统

**掉落逻辑**
```javascript
// 敌人死亡时掉落
spawnDrop(x, y)

// 掉落概率分布
- 药水: 35%
- 大药水: 15%
- 武器: 10%
- 护甲: 10%
- 头盔: 8%
- 饰品: 7%
- 金币: 15%
```

**自动拾取**
1. 物品掉落时从敌人位置下落
2. 玩家靠近时（<80像素）自动飞向玩家
3. 接触后自动进入背包
4. 显示获取提示消息

### 4.6 商店系统

**商店功能**
- **购买**: 消耗金币购买随机品质的装备
- **出售**: 将不需要的装备出售换取金币
- **刷新**: 消耗金币刷新商店物品

**商店物品生成**
- 根据玩家等级生成对应品质的装备
- 每次刷新生成 6 件物品
- 刷新费用随刷新次数增加

```javascript
// 商店物品品质分布（按等级）
- 1-5级: 普通/优秀
- 6-10级: 优秀/稀有
- 11-15级: 稀有/史诗
- 16级以上: 史诗/传说
```

### 4.7 背包系统

**背包特性**
- 无限容量（无数量限制）
- 已装备物品显示 "E" 标记
- 点击物品可装备/卸下
- 支持拖拽整理（未来版本）

### 4.8 关卡系统

```javascript
// 消灭所有敌人后进入下一关
if (enemies.length === 0 && !boss) {
    mapLevel++;
    generateMap();   // 重新生成地图
    spawnEnemies();  // 生成新敌人
}
```

---

## 5. 控制方式

### 5.1 键盘控制
| 按键 | 功能 |
|------|------|
| W / ↑ | 上移 |
| S / ↓ | 下移 |
| A / ← | 左移 |
| D / → | 右移 |
| 空格 / J | 攻击 |
| 1-5 | 使用技能 |

### 5.2 触屏控制
- 虚拟方向键（D-Pad）
- 攻击按钮

---

## 6. 扩展指南

### 6.1 添加新物品

在 `items` 数组中添加：
```javascript
{ 
    id: 'new_item', 
    name: '新物品', 
    type: 'weapon', // 或 armor/helmet/accessory/consumable
    atk: 30,        // 攻击力（武器）
    def: 15,        // 防御力（防具）
    icon: '🆕',     // 图标
    sprite: 'new'    // 像素样式标识
}
```

### 6.2 添加新技能

在 `skills` 数组中添加：
```javascript
{
    id: 'new_skill',
    name: '新技能',
    icon: '🌀',
    mp: 20,
    cd: 60,
    damage: 2.0,
    range: 80,
    type: 'single', // single/projectile/aoe/self/spin
    desc: '技能描述'
}
```

### 6.3 添加新 Boss

在 `spawnBoss()` 函数中添加：
```javascript
const bossTypes = [
    { name: '新Boss', hp: 500, atk: 50, def: 20, ... }
];
```

### 6.4 修改掉落率

在 `spawnDrop()` 函数中调整概率分布。

---

## 7. 性能优化

### 7.1 已实现的优化
- 使用 `requestAnimationFrame` 实现流畅动画
- 对象池复用（粒子、掉落物）
- 只渲染可见区域（可扩展）

### 7.2 可能的优化方向
- Canvas 分层渲染（背景/实体/UI 分离）
- 对象池管理
- 瓦片地图渲染优化

---

## 8. 已知限制

1. **无音效**: 当前版本无背景音乐和音效
2. **无联机**: 仅支持单机游戏

---

## 9. 新增功能（v1.1）

### 9.1 音效系统
游戏内置 Web Audio API 音效：
- **攻击音效**: 挥砍声音
- **命中音效**: 击中敌人
- **拾取音效**: 获得物品
- **升级音效**: 升级提示音
- **Boss音效**: Boss出现提示

### 9.2 存档系统
- **存档**: 点击 💾 按钮或按 F5
- **读档**: 点击 📂 按钮或按 F9
- **重置**: 点击 🔄 按钮
- 使用 localStorage 本地保存

### 9.3 测试功能
在浏览器控制台输入以下命令：
```javascript
runTests()           // 运行所有测试
spawnTestEnemy()     // 生成测试敌人
killAllEnemies()     // 消灭所有敌人
giveRandomItem()     // 获得随机物品
giveGold(100)        // 获得金币
testAttack()         // 测试攻击动画
testSkillAnimation()// 测试技能动画
testLevelUp()        // 测试升级
testBoss()           // 测试Boss
testDrop()           // 测试掉落
```

---

## 10. 新增功能（v1.2）

### 10.1 模块化重构
将单文件拆分为模块化结构：
- `js/data.js` - 数据层（物品、技能、敌人类型）
- `js/renderer.js` - 渲染层（精灵、地图、特效）
- `js/game.js` - 逻辑层（游戏循环、UI交互）
- `css/style.css` - 样式层

### 10.2 装备品质系统
添加5种装备品质等级：
- **普通 (Common)**: 白色 - 100% 属性
- **优秀 (Uncommon)**: 绿色 - 150% 属性，等级+5
- **稀有 (Rare)**: 蓝色 - 200% 属性，等级+10
- **史诗 (Epic)**: 紫色 - 300% 属性，等级+15
- **传说 (Legendary)**: 金色 - 500% 属性，等级+20

### 10.3 商店系统
- **商店按钮**: 右上角 🏪 按钮
- **购买功能**: 消耗金币购买随机品质装备
- **出售功能**: 将背包装备出售换取金币（50%价格返还）
- **刷新功能**: 消耗金币刷新商店物品

### 10.4 背包系统
- **无限容量**: 移除背包容量限制
- **装备标记**: 已装备物品显示 "E" 标记
- **快捷操作**: 点击背包物品即可装备/卸下

### 10.5 角色面板
- **装备显示**: 角色周围显示6个装备槽
- **外观变化**: 装备不同武器/防具会改变角色外观
- **属性面板**: 显示当前攻击、防御、生命值、魔法值

### 10.6 MP药水
新增魔法值恢复道具：
- 🧿 中型MP药水 - 恢复30点MP
- 💧 大型MP药水 - 恢复60点MP

### 10.7 地图系统
- **瓦片类型**: 墙壁(1)、草地(2)、水(3)、地面(0)
- **草地效果**: 玩家/敌人站在草地上有动画效果
- **水域效果**: 水区域有动态波浪动画

### 10.8 呼吸动画
- 玩家角色有轻微的呼吸动画（上下浮动）
- 普通敌人有呼吸动画
- Boss 有特殊的呼吸动画

### 10.9 基础属性调整
- 基础MP: 50 → 150
- 升级属性加成:
  - HP +30
  - MP +15
  - ATK +5
  - DEF +3
  - HP回复 +0.5
  - MP回复 +0.3

### 10.10 IndexedDB 存档系统
- 使用 IndexedDB 替代 localStorage
- 更大的存储容量
- 更好的性能

### 10.11 UI 优化
- 统一面板设计风格（深色毛玻璃背景）
- 装备对比确认面板（穿戴/出售选择）
- 一键出售功能（按品质快速出售）
- 金色传说装备闪光特效

### 10.12 移动端优化
- 禁止文字/按钮选中
- 触摸设备兼容性提升

### 10.13 怪物AI优化
- 5种巡逻模式（横向/竖向/转圈/徘徊/静止）
- 仇恨系统（被击中后主动追击）
- 追击速度提升

---

## 11. 新增功能（v1.3）

### 11.1 地图装饰
- **小山 (tile 4)**: 绿色渐变山丘，带呼吸动画
- **树木 (tile 5)**: 5种随机形态，带摇摆动画
- **花朵 (tile 6)**: 6种颜色，摇摆动画

### 11.2 天气系统
- **白云**: 随机大小/方向/速度，完全不透明
- **乌云**: 深灰色，35%概率生成
- **闪电云**: 黑色，带⚡️图标，每2秒随机劈下
  - 击中玩家: 1点伤害
  - 击中怪物: 2点伤害
  - 击中Boss: 3点伤害

### 11.3 伤害数字系统
- 红色伤害数字: 受伤时显示 -1、-2 等
- 绿色回复数字: 生命回复时显示 +1、+2 等
- 数字向上飘动并淡出

---

## 12. 未来扩展

- [ ] 成就系统
- [ ] 技能树系统
- [ ] 宠物系统
- [ ] 成就系统
- [ ] 本地存档保存
- [ ] 音效和背景音乐
- [ ] 动画系统优化
- [ ] 触控手势支持
- [ ] 联机多人模式

---

## 12. 许可证

本项目为开源项目，可自由学习和修改。

---

*文档版本: 1.5*  
*最后更新: 2026-02-17*
